name: 'Setup Ubuntu Packages'
description: 'Configure Ubuntu mirrors and install packages for faster, reliable CI builds'
branding:
  icon: 'download'
  color: 'orange'
inputs:
  enable_mirrors:
    description: 'Enable mirror configuration for faster downloads'
    required: false
    default: 'true'
  mirror_url:
    description: 'Primary mirror URL (e.g., https://mirror.init7.net/ubuntu/)'
    required: false
    default: 'https://mirror.init7.net/ubuntu/'
  backup_mirrors:
    description: 'Backup mirror URLs (comma-separated)'
    required: false
    default: 'https://mirror.math.princeton.edu/pub/ubuntu/,https://ftp.halifax.rwth-aachen.de/ubuntu/,https://mirrors.kernel.org/ubuntu/'
  packages:
    description: 'List of packages to install (YAML list or space-separated string)'
    required: false
    default: |
      - git
      - curl
  extra_packages:
    description: 'Additional packages to install (YAML list or space-separated string)'
    required: false
    default: ''
  update_cache:
    description: 'Run apt-get update before package installation'
    required: false
    default: 'true'
  ubuntu_version:
    description: 'Ubuntu version codename (auto-detected if empty)'
    required: false
    default: ''
  retry_count:
    description: 'Number of retry attempts for package installation'
    required: false
    default: '2'
  cache_timeout:
    description: 'Timeout in seconds for package operations'
    required: false
    default: '120'

outputs:
  mirror_configured:
    description: 'Whether mirrors were configured successfully'
    value: ${{ steps.run-script.outputs.configured }}
  packages_installed:
    description: 'List of successfully installed packages'
    value: ${{ steps.run-script.outputs.installed }}
  ubuntu_codename:
    description: 'Detected Ubuntu codename'
    value: ${{ steps.run-script.outputs.codename }}

runs:
  using: "composite"
  steps:
    - name: Run setup-ubuntu-packages script
      id: run-script
      shell: bash
      env:
        ENABLE_MIRRORS: ${{ inputs.enable_mirrors }}
        MIRROR_URL: ${{ inputs.mirror_url }}
        BACKUP_MIRRORS: ${{ inputs.backup_mirrors }}
        PACKAGES: ${{ inputs.packages }}
        EXTRA_PACKAGES: ${{ inputs.extra_packages }}
        UPDATE_CACHE: ${{ inputs.update_cache }}
        UBUNTU_VERSION: ${{ inputs.ubuntu_version }}
        RETRY_COUNT: ${{ inputs.retry_count }}
        CACHE_TIMEOUT: ${{ inputs.cache_timeout }}
      run: |
        set -euo pipefail
        
        # Colors for output
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        NC='\033[0m' # No Color
        
        # Logging functions
        log_info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
        log_success() { echo -e "${GREEN}âœ… $1${NC}"; }
        log_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
        log_error() { echo -e "${RED}âŒ $1${NC}"; }
        
        # Normalize package lists to space-separated strings
        # Remove YAML list markers (-) and convert newlines to spaces
        export PACKAGES="$(echo "${PACKAGES}" | sed 's/^[[:space:]]*-[[:space:]]*//' | tr '\n' ' ')"
        export EXTRA_PACKAGES="$(echo "${EXTRA_PACKAGES}" | sed 's/^[[:space:]]*-[[:space:]]*//' | tr '\n' ' ')"
        
        # Detect Ubuntu version
        if [ -z "$UBUNTU_VERSION" ]; then
          UBUNTU_CODENAME=$(lsb_release -sc 2>/dev/null || grep VERSION_CODENAME /etc/os-release | cut -d= -f2 | tr -d '"' || echo "noble")
          log_info "Auto-detected Ubuntu codename: $UBUNTU_CODENAME"
        else
          UBUNTU_CODENAME="$UBUNTU_VERSION"
          log_info "Using provided Ubuntu codename: $UBUNTU_CODENAME"
        fi
        
        # Configure mirrors
        MIRROR_CONFIGURED="false"
        if [ "$ENABLE_MIRRORS" = "true" ]; then
          log_info "ðŸŒ Configuring Ubuntu mirrors for faster downloads..."
          
          # Backup original sources
          if [ -f /etc/apt/sources.list ]; then
            sudo cp /etc/apt/sources.list /etc/apt/sources.list.backup
          fi
          
          # Remove trailing slash if present
          CLEAN_MIRROR_URL="${MIRROR_URL%/}"
          
          # Create optimized sources.list with primary mirror
          sudo tee /etc/apt/sources.list > /dev/null << EOF
        # Ubuntu Mirror Configuration - Generated by setup-ubuntu-packages action
        # Primary mirror: $CLEAN_MIRROR_URL (optimized for CI efficiency)
        
        # Main repository - prioritize main and universe (most CI packages)
        deb $CLEAN_MIRROR_URL $UBUNTU_CODENAME main universe
        deb $CLEAN_MIRROR_URL $UBUNTU_CODENAME-updates main universe
        
        # Additional components only if needed
        deb $CLEAN_MIRROR_URL $UBUNTU_CODENAME restricted multiverse
        deb $CLEAN_MIRROR_URL $UBUNTU_CODENAME-updates restricted multiverse
        
        # Security updates (use same mirror for reliability)
        deb $CLEAN_MIRROR_URL $UBUNTU_CODENAME-security main restricted universe multiverse
        EOF
          
          MIRROR_CONFIGURED="true"
          log_success "Mirror configured: $CLEAN_MIRROR_URL"
        else
          log_info "Mirror configuration disabled, using default repositories"
          MIRROR_CONFIGURED="disabled"
        fi
        
        # Update package cache
        if [ "$UPDATE_CACHE" = "true" ]; then
          log_info "ðŸ“¦ Updating package cache..."
          
          attempt=1
          while [ $attempt -le $RETRY_COUNT ]; do
            if sudo timeout "$CACHE_TIMEOUT" apt-get update -qq; then
              log_success "Package cache updated successfully"
              break
            fi
            
            log_warning "apt-get update failed (attempt $attempt/$RETRY_COUNT)"
            
            # On failure, try fallback mirrors if mirrors are enabled
            if [ "$ENABLE_MIRRORS" = "true" ] && [ $attempt -lt $RETRY_COUNT ]; then
              IFS=',' read -ra BACKUP_ARRAY <<< "$BACKUP_MIRRORS"
              if [ ${#BACKUP_ARRAY[@]} -ge $attempt ]; then
                FALLBACK_MIRROR="${BACKUP_ARRAY[$((attempt-1))]}"
                log_warning "Trying fallback mirror: $FALLBACK_MIRROR"
                
                # Update sources.list with fallback mirror
                CLEAN_FALLBACK="${FALLBACK_MIRROR%/}"
                sudo sed -i "s|$CLEAN_MIRROR_URL|$CLEAN_FALLBACK|g" /etc/apt/sources.list
                MIRROR_CONFIGURED="fallback"
              fi
            fi
            
            attempt=$((attempt + 1))
            [ $attempt -le $RETRY_COUNT ] && sleep 5
          done
          
          if [ $attempt -gt $RETRY_COUNT ]; then
            log_error "Failed to update package cache after $RETRY_COUNT attempts"
            exit 1
          fi
        else
          log_info "Skipping apt-get update as requested"
        fi
        
        # Combine all packages
        ALL_PACKAGES="$PACKAGES $EXTRA_PACKAGES"
        ALL_PACKAGES=$(echo "$ALL_PACKAGES" | xargs) # Trim whitespace
        
        # Install packages
        PACKAGES_INSTALLED=""
        if [ -n "$ALL_PACKAGES" ]; then
          log_info "ðŸ“¦ Installing packages: $ALL_PACKAGES"
          
          attempt=1
          while [ $attempt -le $RETRY_COUNT ]; do
            if sudo DEBIAN_FRONTEND=noninteractive timeout "$CACHE_TIMEOUT" \
               apt-get install -y --no-install-recommends $ALL_PACKAGES; then
              log_success "Packages installed successfully"
              PACKAGES_INSTALLED="$ALL_PACKAGES"
              break
            fi
            
            log_warning "Package installation failed (attempt $attempt/$RETRY_COUNT)"
            attempt=$((attempt + 1))
            [ $attempt -le $RETRY_COUNT ] && sleep 5
          done
          
          if [ $attempt -gt $RETRY_COUNT ]; then
            log_error "Failed to install packages after $RETRY_COUNT attempts"
            exit 1
          fi
        else
          log_info "No packages to install"
        fi
        
        # Set outputs for GitHub Actions
        if [ -n "${GITHUB_OUTPUT:-}" ]; then
          echo "mirror_configured=$MIRROR_CONFIGURED" >> "$GITHUB_OUTPUT"
          echo "packages_installed=$PACKAGES_INSTALLED" >> "$GITHUB_OUTPUT"
          echo "ubuntu_codename=$UBUNTU_CODENAME" >> "$GITHUB_OUTPUT"
        fi
        
        log_success "Setup completed successfully!"